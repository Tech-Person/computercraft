-- =====================
-- USER CONFIG
-- =====================
local reactorSide = "back"
local outputGateSide = "top"

-- MODEM-CONNECTED INPUT FLOW GATE NAME
local INPUT_GATE_NAME = "flow_gate_1" -- CHANGE IF NEEDED

local targetStrength = 50
local maxTemperature = 8000
local safeTemperature = 3000
local lowestFieldPercent = 15
local activateOnCharged = 1

-- =====================
-- SYSTEM SETUP
-- =====================
os.loadAPI("lib/f")

local autoInputGate = 1
local curInputGate = 222000

local monitor = f.periphSearch("monitor")
local reactor = peripheral.wrap(reactorSide)
local fluxgate = peripheral.wrap(outputGateSide)
local inputfluxgate = peripheral.wrap(INPUT_GATE_NAME)

if not monitor then error("No monitor found") end
if not reactor then error("No reactor found") end
if not fluxgate then error("No output gate found") end
if not inputfluxgate then error("Input gate not found: "..INPUT_GATE_NAME) end

-- FORCE OVERRIDE MODE (CRITICAL)
fluxgate.setOverrideEnabled(true)
inputfluxgate.setOverrideEnabled(true)

local monX, monY = monitor.getSize()
local mon = { monitor = monitor, X = monX, Y = monY }

-- =====================
-- STATE
-- =====================
local action = "None since reboot"
local emergencyCharge = false
local emergencyTemp = false
local ri

local gateStatus = { input = "UNKNOWN", output = "UNKNOWN" }

-- DIRTY CACHE (INITIALIZED!)
local last = {
  status = false,
  generation = false,
  temperature = false,
  energy = false,
  field = false,
  fuel = false,
  inGate = false,
  outGate = false,
  autoMode = false,
  inputFlow = false,   -- MODIFIED: input flow display
  outputFlow = false,  -- MODIFIED: output flow display

}

-- =====================
-- UI STATIC
-- =====================
local function drawButtons(y)
  f.draw_text(mon, 2, y, " < ", colors.white, colors.gray)
  f.draw_text(mon, 6, y, " <<", colors.white, colors.gray)
  f.draw_text(mon, 10, y, "<<<", colors.white, colors.gray)
  f.draw_text(mon, 17, y, ">>>", colors.white, colors.gray)
  f.draw_text(mon, 21, y, ">> ", colors.white, colors.gray)
  f.draw_text(mon, 25, y, " > ", colors.white, colors.gray)
end

local function drawStaticUI()
  f.clear(mon)
  f.draw_text(mon, 2, 2, "Reactor Status", colors.white, colors.black)
  f.draw_text(mon, 2, 4, "Generation", colors.white, colors.black)
  f.draw_text(mon, 2, 6, "Temperature", colors.white, colors.black)
  f.draw_text(mon, 2, 7, "Output Gate", colors.white, colors.black)
  drawButtons(8)
  f.draw_text(mon, 2, 9, "Input Gate", colors.white, colors.black)
  f.draw_text(mon, 2, 11, "Energy Saturation", colors.white, colors.black)
  f.draw_text(mon, 2, 14, "Field Strength", colors.white, colors.black)
  f.draw_text(mon, 2, 17, "Fuel", colors.white, colors.black)
  f.draw_text(mon, 2, 19, "Action", colors.gray, colors.black)
  f.draw_text(mon, 2, 20, "Gate Status", colors.gray, colors.black)
end

drawStaticUI()
-- =====================
-- FLOW RATE READOUTS
-- =====================
local outputFlow = fluxgate.getFlow()
if outputFlow ~= last.outputFlow then
  f.draw_text(
    mon,
    18, 7,  -- same line as "Output Gate"
    f.format_int(outputFlow) .. " rf/t",
    colors.blue,
    colors.black
  )
  last.outputFlow = outputFlow
end

-- =====================
-- INPUT FLOW DISPLAY (TARGET-BASED)
-- =====================
local displayInputFlow

if autoInputGate == 1 then
  -- AUTO: show computed target
  displayInputFlow = math.floor(
    ri.fieldDrainRate / (1 - targetStrength / 100)
  )
else
  -- MANUAL: show user-selected value
  displayInputFlow = curInputGate
end

if displayInputFlow ~= last.inputFlow then
  f.draw_text(
    mon,
    18, 9,
    f.format_int(displayInputFlow) .. " rf/t",
    colors.blue,
    colors.black
  )
  last.inputFlow = displayInputFlow
end

-- OPTIONAL: actual gate flow (debug)
local actual = inputfluxgate.getFlow()
f.draw_text(mon, 30, 9, "(" .. f.format_int(actual) .. ")", colors.gray, colors.black)

-- =====================
-- BUTTON HANDLER
-- =====================
local function buttons()
  while true do
    local _, _, x, y = os.pullEvent("monitor_touch")

    -- OUTPUT GATE (override only)
    if y == 8 then
      local v = fluxgate.getFlow()
      if x <= 4 then v = v - 1000
      elseif x <= 9 then v = v - 10000
      elseif x <= 12 then v = v - 100000
      elseif x >= 25 then v = v + 1000
      elseif x >= 21 then v = v + 10000
      elseif x >= 17 then v = v + 100000 end
      fluxgate.setFlowOverride(math.max(v, 0))
    end

    -- INPUT GATE MANUAL
    if y == 10 and autoInputGate == 0 and x ~= 14 and x ~= 15 then
      if x <= 4 then curInputGate = curInputGate - 1000
      elseif x <= 9 then curInputGate = curInputGate - 10000
      elseif x <= 12 then curInputGate = curInputGate - 100000
      elseif x >= 25 then curInputGate = curInputGate + 1000
      elseif x >= 21 then curInputGate = curInputGate + 10000
      elseif x >= 17 then curInputGate = curInputGate + 100000 end
      inputfluxgate.setFlowOverride(math.max(curInputGate, 0))
    end

    if y == 10 and (x == 14 or x == 15) then
      autoInputGate = autoInputGate == 1 and 0 or 1
    end
  end
end

-- =====================
-- MAIN LOOP
-- =====================
local function update()
  while true do
    ri = reactor.getReactorInfo()
    if not ri then error("Invalid reactor setup") end

    -- =====================
    -- DRAW REACTOR VALUES
    -- =====================
    if ri.status ~= last.status then
      local c =
        (ri.status == "online" or ri.status == "charged") and colors.green or
        (ri.status == "charging") and colors.orange or
        colors.red

      f.draw_text(mon, 18, 2, string.upper(ri.status), colors.white, c)
      last.status = ri.status
    end

    if ri.generationRate ~= last.generation then
      f.draw_text(mon, 18, 4,
        f.format_int(ri.generationRate) .. " rf/t",
        colors.lime, colors.black)
      last.generation = ri.generationRate
    end

    if ri.temperature ~= last.temperature then
      local tc =
        ri.temperature <= 5000 and colors.green or
        ri.temperature <= 6500 and colors.orange or
        colors.red

      f.draw_text(mon, 18, 6,
        f.format_int(ri.temperature) .. "C",
        colors.white, tc)
      last.temperature = ri.temperature
    end

    -- =====================
    -- PROGRESS BARS
    -- =====================
    local satPercent =
      math.ceil(ri.energySaturation / ri.maxEnergySaturation * 10000) * 0.01
    if satPercent ~= last.energy then
      f.progress_bar(mon, 2, 12, mon.X - 2, satPercent, 100,
        colors.blue, colors.gray)
      last.energy = satPercent
    end

    local fieldPercent =
      math.ceil(ri.fieldStrength / ri.maxFieldStrength * 10000) * 0.01
    local fc =
      fieldPercent >= 50 and colors.green or
      fieldPercent > 30 and colors.orange or
      colors.red
    if fieldPercent ~= last.field then
      f.progress_bar(mon, 2, 15, mon.X - 2, fieldPercent, 100,
        fc, colors.gray)
      last.field = fieldPercent
    end

    local fuelPercent =
      100 - math.ceil(ri.fuelConversion / ri.maxFuelConversion * 10000) * 0.01
    local fu =
      fuelPercent >= 70 and colors.green or
      fuelPercent > 30 and colors.orange or
      colors.red
    if fuelPercent ~= last.fuel then
      f.progress_bar(mon, 2, 18, mon.X - 2, fuelPercent, 100,
        fu, colors.gray)
      last.fuel = fuelPercent
    end
-- =====================
-- INPUT MODE INDICATOR (AU / MA)
-- =====================
if autoInputGate ~= last.autoMode then
  f.draw_text(
    mon,
    14, 10,                           -- same position your button handler expects
    autoInputGate == 1 and "AU" or "MA",
    colors.white,
    colors.gray
  )
  last.autoMode = autoInputGate
end
-- =====================
-- INPUT GATE MANUAL BUTTONS
-- =====================
if autoInputGate == 0 then
  drawButtons(10) -- same style as output gate
end

-- =====================
-- INPUT GATE CONTROL
-- =====================
if ri.status == "online" and autoInputGate == 1 then
  -- AUTO MODE ONLY
  local flow = ri.fieldDrainRate / (1 - targetStrength / 100)
  inputfluxgate.setFlowOverride(flow)
end
-- MANUAL MODE: gate is controlled ONLY by button presses


    -- =====================
    -- GATE DIAGNOSTICS
    -- =====================
    gateStatus.input  = inputfluxgate.getFlow() > 0 and "OK" or "STALLED"
    gateStatus.output = fluxgate.getFlow() > 0 and "OK" or "STALLED"

    if gateStatus.input ~= last.inGate or gateStatus.output ~= last.outGate then
      f.draw_text(mon, 18, 20,
        "IN:" .. gateStatus.input .. "  OUT:" .. gateStatus.output,
        colors.white,
        (gateStatus.input == "OK" and gateStatus.output == "OK")
          and colors.green or colors.red)
      last.inGate = gateStatus.input
      last.outGate = gateStatus.output
    end

    -- =====================
    -- SAFETIES
    -- =====================
    if fuelPercent <= 10 then
      reactor.stopReactor()
      action = "Fuel below 10%"
    end

    if fieldPercent <= lowestFieldPercent and ri.status == "online" then
      reactor.stopReactor()
      reactor.chargeReactor()
      emergencyCharge = true
      action = "Field Strength Low"
    end

    if ri.temperature > maxTemperature then
      reactor.stopReactor()
      emergencyTemp = true
      action = "Temperature High"
    end

    sleep(0.1)
  end
end

parallel.waitForAny(buttons, update)
