-- =====================
-- USER CONFIG
-- =====================
local reactorSide = "back"
local outputGateSide = "top"
local INPUT_GATE_NAME = "flow_gate_1"

local targetStrength = 50

-- =====================
-- SETUP
-- =====================
os.loadAPI("lib/f")

local autoInputGate = 1
local curInputGate = 222000

local monitor = f.periphSearch("monitor")
local reactor = peripheral.wrap(reactorSide)
local outputGate = peripheral.wrap(outputGateSide)
local inputGate = peripheral.wrap(INPUT_GATE_NAME)

assert(monitor, "Monitor not found")
assert(reactor, "Reactor not found")
assert(outputGate, "Output gate not found")
assert(inputGate, "Input gate not found")

outputGate.setOverrideEnabled(true)
inputGate.setOverrideEnabled(true)

local monX, monY = monitor.getSize()
local mon = { monitor = monitor, X = monX, Y = monY }

-- =====================
-- DIRTY CACHE
-- =====================
local last = {}

-- =====================
-- UI HELPERS
-- =====================
local function drawButtons(y)
  f.draw_text(mon, 2, y, " < ", colors.white, colors.gray)
  f.draw_text(mon, 6, y, " <<", colors.white, colors.gray)
  f.draw_text(mon, 10, y, "<<<", colors.white, colors.gray)
  f.draw_text(mon, 17, y, ">>>", colors.white, colors.gray)
  f.draw_text(mon, 21, y, ">> ", colors.white, colors.gray)
  f.draw_text(mon, 25, y, " > ", colors.white, colors.gray)
end

local function drawStatic()
  f.clear(mon)
  f.draw_text(mon, 2, 2, "Reactor Status", colors.white, colors.black)
  f.draw_text(mon, 2, 4, "Generation", colors.white, colors.black)
  f.draw_text(mon, 2, 6, "Temperature", colors.white, colors.black)
  f.draw_text(mon, 2, 7, "Output Gate", colors.white, colors.black)
  drawButtons(8)
  f.draw_text(mon, 2, 9, "Input Gate", colors.white, colors.black)
  f.draw_text(mon, 2, 11, "Energy Saturation", colors.white, colors.black)
  f.draw_text(mon, 2, 14, "Field Strength", colors.white, colors.black)
  f.draw_text(mon, 2, 17, "Fuel", colors.white, colors.black)
end

drawStatic()

-- =====================
-- BUTTON HANDLER
-- =====================
local function buttons()
  while true do
    local _, _, x, y = os.pullEvent("monitor_touch")

    if y == 8 then
      local v = outputGate.getFlow()
      if x <= 4 then v = v - 1000
      elseif x <= 9 then v = v - 10000
      elseif x <= 12 then v = v - 100000
      elseif x >= 25 then v = v + 1000
      elseif x >= 21 then v = v + 10000
      elseif x >= 17 then v = v + 100000 end
      outputGate.setFlowOverride(math.max(v, 0))
    end

    if y == 10 and autoInputGate == 0 then
      if x <= 4 then curInputGate = curInputGate - 1000
      elseif x <= 9 then curInputGate = curInputGate - 10000
      elseif x <= 12 then curInputGate = curInputGate - 100000
      elseif x >= 25 then curInputGate = curInputGate + 1000
      elseif x >= 21 then curInputGate = curInputGate + 10000
      elseif x >= 17 then curInputGate = curInputGate + 100000 end
      inputGate.setFlowOverride(math.max(curInputGate, 0))
    end

    if y == 10 and (x == 14 or x == 15) then
      autoInputGate = autoInputGate == 1 and 0 or 1
      last.inputDisplay = nil
    end
  end
end

-- =====================
-- MAIN LOOP (SINGLE SOURCE OF TRUTH)
-- =====================
local function update()
  while true do
    local ri = reactor.getReactorInfo()

    if ri then
      -- -------- INPUT FLOW TARGET --------
      local inputTarget =
        autoInputGate == 1
        and math.floor(ri.fieldDrainRate / (1 - targetStrength / 100))
        or curInputGate

      if autoInputGate == 1 then
        inputGate.setFlowOverride(inputTarget)
      end

      -- -------- DRAW INPUT FLOW --------
      if inputTarget ~= last.inputDisplay then
        f.draw_text(mon, 18, 9,
          f.format_int(inputTarget) .. " rf/t",
          colors.blue, colors.black)
        last.inputDisplay = inputTarget
      end

      -- -------- AU / MA --------
      if autoInputGate ~= last.mode then
        f.draw_text(mon, 14, 10,
          autoInputGate == 1 and "AU" or "MA",
          colors.white, colors.gray)
        last.mode = autoInputGate
      end

      if autoInputGate == 0 then
        drawButtons(10)
      end
    end

    sleep(0.1)
  end
end

parallel.waitForAny(buttons, update)
