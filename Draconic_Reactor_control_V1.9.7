-- =====================
-- USER CONFIG
-- =====================
local reactorSide = "back"
local outputGateSide = "top"
local INPUT_GATE_NAME = "flow_gate_1"

local targetStrength = 50
local maxTemperature = 8000
local safeTemperature = 3000
local lowestFieldPercent = 15

-- =====================
-- SYSTEM SETUP
-- =====================
os.loadAPI("lib/f")

local autoInputGate = 1
local curInputGate = 222000

local monitor = f.periphSearch("monitor")
local reactor = peripheral.wrap(reactorSide)
local fluxgate = peripheral.wrap(outputGateSide)
local inputfluxgate = peripheral.wrap(INPUT_GATE_NAME)

assert(monitor, "No monitor found")
assert(reactor, "No reactor found")
assert(fluxgate, "No output gate found")
assert(inputfluxgate, "No input gate found")

fluxgate.setOverrideEnabled(true)
inputfluxgate.setOverrideEnabled(true)

local monX, monY = monitor.getSize()
local mon = { monitor = monitor, X = monX, Y = monY }

-- =====================
-- STATE / CACHE
-- =====================
local last = {
  status = nil,
  generation = nil,
  temperature = nil,
  energy = nil,
  field = nil,
  fuel = nil,
  inputFlow = nil,
  outputFlow = nil,
  autoMode = nil,
}

-- =====================
-- UI HELPERS
-- =====================
local function drawButtons(y)
  f.draw_text(mon, 2, y, " < ", colors.white, colors.gray)
  f.draw_text(mon, 6, y, " <<", colors.white, colors.gray)
  f.draw_text(mon, 10, y, "<<<", colors.white, colors.gray)
  f.draw_text(mon, 17, y, ">>>", colors.white, colors.gray)
  f.draw_text(mon, 21, y, ">> ", colors.white, colors.gray)
  f.draw_text(mon, 25, y, " > ", colors.white, colors.gray)
end

local function drawStaticUI()
  f.clear(mon)
  f.draw_text(mon, 2, 2, "Reactor Status", colors.white, colors.black)
  f.draw_text(mon, 2, 4, "Generation", colors.white, colors.black)
  f.draw_text(mon, 2, 6, "Temperature", colors.white, colors.black)
  f.draw_text(mon, 2, 7, "Output Gate", colors.white, colors.black)
  drawButtons(8)
  f.draw_text(mon, 2, 9, "Input Gate", colors.white, colors.black)
  f.draw_text(mon, 2, 11, "Energy Saturation", colors.white, colors.black)
  f.draw_text(mon, 2, 14, "Field Strength", colors.white, colors.black)
  f.draw_text(mon, 2, 17, "Fuel", colors.white, colors.black)
end

drawStaticUI()

-- =====================
-- BUTTON HANDLER
-- =====================
local function buttons()
  while true do
    local _, _, x, y = os.pullEvent("monitor_touch")

    if y == 8 then
      local v = fluxgate.getFlow()
      if x <= 4 then v = v - 1000
      elseif x <= 9 then v = v - 10000
      elseif x <= 12 then v = v - 100000
      elseif x >= 25 then v = v + 1000
      elseif x >= 21 then v = v + 10000
      elseif x >= 17 then v = v + 100000 end
      fluxgate.setFlowOverride(math.max(v, 0))
    end

    if y == 10 and autoInputGate == 0 then
      if x <= 4 then curInputGate = curInputGate - 1000
      elseif x <= 9 then curInputGate = curInputGate - 10000
      elseif x <= 12 then curInputGate = curInputGate - 100000
      elseif x >= 25 then curInputGate = curInputGate + 1000
      elseif x >= 21 then curInputGate = curInputGate + 10000
      elseif x >= 17 then curInputGate = curInputGate + 100000 end
      inputfluxgate.setFlowOverride(math.max(curInputGate, 0))
    end

    if y == 10 and (x == 14 or x == 15) then
      autoInputGate = autoInputGate == 1 and 0 or 1
      last.inputFlow = nil -- force redraw
    end
  end
end

-- =====================
-- MAIN LOOP
-- =====================
local function update()
  while true do
    local ri = reactor.getReactorInfo()
    if not ri then sleep(0.1) goto continue end

    -- DISPLAY VALUES
    local displayInputFlow =
      autoInputGate == 1
      and math.floor(ri.fieldDrainRate / (1 - targetStrength / 100))
      or curInputGate

    if displayInputFlow ~= last.inputFlow then
      f.draw_text(mon, 18, 9,
        f.format_int(displayInputFlow) .. " rf/t",
        colors.blue, colors.black)
      last.inputFlow = displayInputFlow
    end

    if autoInputGate ~= last.autoMode then
      f.draw_text(mon, 14, 10,
        autoInputGate == 1 and "AU" or "MA",
        colors.white, colors.gray)
      last.autoMode = autoInputGate
    end

    if autoInputGate == 0 then drawButtons(10) end

    -- APPLY AUTO FLOW
    if autoInputGate == 1 then
      inputfluxgate.setFlowOverride(displayInputFlow)
    end

    ::continue::
    sleep(0.1)
  end
end

parallel.waitForAny(buttons, update)
